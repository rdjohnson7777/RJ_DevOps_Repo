---
name: Infrastructure Pipeline to create AWS EC2, install Ansible Container, and execute STIG playbook (Production)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  terraform_plan:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Debug filesystem
        run: |
          pwd
          ls -la
          echo "----"
          ls -la code || true
          echo "----"
          find . -maxdepth 4 -type d

      - name: Terraform Init
        working-directory: code/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: code/terraform
        run: terraform plan -var="my_public_ip=${{ secrets.MY_PUBLIC_IP }}" -out=tfplan

      - name: Upload tfplan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: code/terraform/tfplan

  terraform_apply:
    needs: terraform_plan
    runs-on: ubuntu-latest
    environment: production
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    outputs:
      rhel_ip: ${{ steps.tf_outputs.outputs.rhel_ip }}
      ssh_user: ${{ steps.tf_outputs.outputs.ssh_user }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: code/terraform
        run: terraform init

      - name: Download tfplan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: code/terraform 

      - name: Terraform Apply
        working-directory: code/terraform
        run: terraform apply -var="my_public_ip=${{ secrets.MY_PUBLIC_IP }}" tfplan

      - name: Capture Terraform outputs
        id: tf_outputs
        working-directory: code/terraform
        run: |
          echo "rhel_ip=$(terraform output -raw rhel_public_ip)" >> $GITHUB_OUTPUT
          echo "ssh_user=$(terraform output -raw ssh_user)" >> $GITHUB_OUTPUT

  ansible_check:
    needs: terraform_apply
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Write SSH key
        run: |
          echo "${{ secrets.PRIV_KEY_ALLOW_RUNNER }}" | tr -d '\r' > ssh_key.pem
          chmod 600 ssh_key.pem

### TESTING SSH, DEBUG
      - name: Test SSH connectivity
        run: |
          ssh -i ssh_key.pem -o StrictHostKeyChecking=no \
          ${{ needs.terraform_apply.outputs.ssh_user }}@${{ needs.terraform_apply.outputs.rhel_ip }} \
          "echo SSH SUCCESS"

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible openssh-client sshpass

      - name: Create Ansible inventory
        run: |
          mkdir -p inventory
          cat <<EOF > inventory/hosts
          [rhel8_hosts]
          target ansible_host=${{ needs.terraform_apply.outputs.rhel_ip }} \
                ansible_user=${{ needs.terraform_apply.outputs.ssh_user }} \
                ansible_ssh_private_key_file=ssh_key.pem
          EOF

      - name: Run Ansible STIG hardening (check mode)
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          cd code/ansible
          ansible-playbook -i ../../inventory/hosts STIG_playbook.yml --check

  ansible_enforce:
    needs: ansible_check
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Write SSH key
        run: |
          echo "${{ secrets.PRIV_KEY_ALLOW_RUNNER }}" | tr -d '\r' > ssh_key.pem
          chmod 600 ssh_key.pem

      - name: Install Ansible (enforce stage)
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible openssh-client sshpass

      - name: Run Ansible STIG hardening (enforce mode)
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          cd code/ansible
          ansible-playbook -i ../../inventory/hosts STIG_playbook.yml
